#!/bin/bash
# Script de Git para subir cambios con selecci√≥n de rama
# Uso: ./subir [mensaje] [rama] [--force]

# Colores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Variables por defecto
COMMIT_MESSAGE="CAMBIOS APP"
BRANCH="main"
USE_FORCE=false

# Procesar argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        --force|-f)
            USE_FORCE=true
            shift
            ;;
        --branch|-b)
            BRANCH="$2"
            shift 2
            ;;
        *)
            if [[ -z "$CUSTOM_MESSAGE_SET" ]]; then
                COMMIT_MESSAGE="$1"
                CUSTOM_MESSAGE_SET=true
            fi
            shift
            ;;
    esac
done

echo -e "${BLUE}================================${NC}"
echo -e "${YELLOW}üöÄ Subiendo cambios a GitHub${NC}"
echo -e "${BLUE}================================${NC}"

# Verificar si estamos en un repo git
if ! git rev-parse --git-dir > /dev/null 2>&1; then
   echo -e "${RED}‚ùå Error: No est√°s en un repositorio Git${NC}"
   exit 1
fi

# Mostrar rama actual
CURRENT_BRANCH=$(git branch --show-current)
echo -e "${BLUE}Rama actual:${NC} $CURRENT_BRANCH"

# Preguntar si quiere cambiar de rama
echo -e "\n${YELLOW}¬øA qu√© rama quieres subir?${NC}"
echo "1) main (por defecto)"
echo "2) mods-coop"
echo "3) Otra rama (especificar)"
echo "4) Quedarse en rama actual ($CURRENT_BRANCH)"
read -p "Opci√≥n [1]: " BRANCH_OPTION

case $BRANCH_OPTION in
    2)
        BRANCH="mods-coop"
        ;;
    3)
        read -p "Nombre de la rama: " BRANCH
        ;;
    4)
        BRANCH="$CURRENT_BRANCH"
        ;;
    *)
        BRANCH="main"
        ;;
esac

echo -e "\n${BLUE}Rama destino:${NC} $BRANCH"

# Cambiar a la rama si es necesario
if [[ "$CURRENT_BRANCH" != "$BRANCH" ]]; then
    echo -e "${YELLOW}Cambiando a rama $BRANCH...${NC}"
    
    # Intentar cambiar a la rama, crearla si no existe
    if git checkout "$BRANCH" 2>/dev/null; then
        echo -e "${GREEN}‚úì Cambiado a rama existente${NC}"
    else
        echo -e "${YELLOW}Creando nueva rama $BRANCH...${NC}"
        git checkout -b "$BRANCH"
    fi
fi

# Mostrar estado
echo -e "\n${YELLOW}Estado del repositorio:${NC}"
git status --short

# Confirmar cambios
read -p "¬øContinuar con estos cambios? [S/n]: " CONFIRM
if [[ "$CONFIRM" =~ ^[Nn] ]]; then
    echo -e "${RED}Operaci√≥n cancelada${NC}"
    exit 0
fi

# Pedir mensaje de commit si no se proporcion√≥
if [[ "$COMMIT_MESSAGE" == "CAMBIOS APP" ]]; then
    read -p "Mensaje del commit [CAMBIOS APP]: " USER_MESSAGE
    if [[ -n "$USER_MESSAGE" ]]; then
        COMMIT_MESSAGE="$USER_MESSAGE"
    fi
fi

echo -e "\n${BLUE}Mensaje:${NC} $COMMIT_MESSAGE"

# Git add
echo -e "\n${YELLOW}üì¶ A√±adiendo archivos...${NC}"
git add .

# Git commit
echo -e "${YELLOW}üíæ Creando commit...${NC}"
if git commit -m "$COMMIT_MESSAGE"; then
    echo -e "${GREEN}‚úì Commit creado${NC}"
else
    echo -e "${YELLOW}‚ö† No hay cambios para commitear${NC}"
fi

# Git push
echo -e "\n${YELLOW}‚òÅÔ∏è  Subiendo a GitHub...${NC}"

PUSH_CMD="git push origin $BRANCH"

# Si es la primera vez que se sube esta rama
if ! git rev-parse --verify "origin/$BRANCH" > /dev/null 2>&1; then
    echo -e "${YELLOW}Primera vez subiendo esta rama, configurando upstream...${NC}"
    PUSH_CMD="git push -u origin $BRANCH"
fi

if [[ "$USE_FORCE" == true ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Usando push forzado...${NC}"
    PUSH_CMD="$PUSH_CMD --force"
fi

# Ejecutar push
if eval $PUSH_CMD; then
    echo -e "\n${GREEN}================================${NC}"
    echo -e "${GREEN}‚úÖ ¬°Cambios subidos exitosamente!${NC}"
    echo -e "${GREEN}================================${NC}"
    echo -e "${BLUE}Rama:${NC} $BRANCH"
    echo -e "${BLUE}URL:${NC} https://github.com/$(git remote get-url origin | sed 's/.*://;s/.git$//')}/tree/$BRANCH"
else
    echo -e "\n${RED}================================${NC}"
    echo -e "${RED}‚ùå Error al subir cambios${NC}"
    echo -e "${RED}================================${NC}"
    
    # Sugerir usar force si fall√≥
    if [[ "$USE_FORCE" == false ]]; then
        echo -e "${YELLOW}Intenta con:${NC} ./subir --force"
    fi
    exit 1
fi
